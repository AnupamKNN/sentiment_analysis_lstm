# name: Sentiment Analysis CI/CD

# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#       - main

# env:
#   # Use dynamic repo owner so it works even if you fork it
#   IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/sentiment_analysis_lstm
#   IMAGE_TAG: latest

# jobs:
#   # 1. Continuous Integration (Test Build & Install)
#   ci_check:
#     name: CI - Install & Check
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Setup Python 3.11
#         uses: actions/setup-python@v4
#         with:
#           python-version: '3.11'

#       - name: Install Dependencies
#         run: |
#           python -m pip install --upgrade pip
#           # Install from your API requirements to ensure they are valid
#           pip install -r requirements-api.txt

#   # 2. Build & Push Docker Image (Only on push to main)
#   build_and_push:
#     name: Build & Push Docker Image
#     runs-on: ubuntu-latest
#     needs: ci_check
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
#     permissions:
#       contents: read
#       packages: write
    
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Log in to GitHub Container Registry
#         uses: docker/login-action@v3
#         with:
#           registry: ghcr.io
#           username: ${{ github.actor }}
#           password: ${{ secrets.GITHUB_TOKEN }}

#       - name: Build and Push Docker image
#         uses: docker/build-push-action@v5
#         with:
#           context: .
#           file: Dockerfile.api
#           push: true
#           tags: ghcr.io/${{ github.repository_owner }}/sentiment_analysis_lstm:latest

#   # 3. Continuous Deployment (Trigger Render)
#   deploy:
#     name: Deploy to Render
#     runs-on: ubuntu-latest
#     needs: build_and_push
#     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
#     steps:
#       - name: Trigger redeployment on Render
#         env:
#           RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
#           SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
#         run: |
#           # This webhook tells Render to pull the new image we just pushed to GHCR
#           curl -X POST "https://api.render.com/v1/services/${SERVICE_ID}/deploys" \
#           -H "Accept: application/json" \
#           -H "Authorization: Bearer ${RENDER_API_KEY}" \
#           -H "Content-Type: application/json" \
#           -d '{"clearCache": "clear"}'